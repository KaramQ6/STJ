<!DOCTYPE html>
<html>
<head>
    <title>Stable AR - SmartTour</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

    <script>
        // Custom component for persistence and position updates
        AFRAME.registerComponent('marker-handler', {
            schema: {
                delay: { type: 'number', default: 30000 },
                target: { type: 'selector' } 
            },

            init: function () {
                const marker = this.el;
                const infoCard = this.data.target;
                const delay = this.data.delay;
                let hideTimeout = null;

                infoCard.setAttribute('visible', false);

                marker.addEventListener('markerFound', () => {
                    if (hideTimeout) {
                        clearTimeout(hideTimeout);
                        hideTimeout = null;
                    }
                    infoCard.setAttribute('visible', true);
                });

                marker.addEventListener('markerLost', () => {
                    hideTimeout = setTimeout(() => {
                        infoCard.setAttribute('visible', false);
                    }, delay);
                });
            },

            // tick function runs on every frame
            tick: function () {
                const marker = this.el;
                const infoCard = this.data.target;

                // If the marker is visible, ONLY update the card's position.
                // The 'look-at' component will handle the rotation smoothly.
                if (marker.object3D.visible) {
                    infoCard.setAttribute('position', marker.object3D.position);
                    // THE ROTATION LINE HAS BEEN REMOVED TO FIX THE FLICKERING
                }
            }
        });
    </script>
</head>

<body style="margin: 0px; overflow: hidden;">

    <a-scene embedded arjs="sourceType: webcam; detectionMode: mono_and_matrix; matrixCodeType: 3x3;">

        <a-marker type="pattern" url="marker.patt" marker-handler="target: #info-card;"></a-marker>
        
        <a-entity id="info-card" look-at="[camera]">
            
            <a-plane 
                width="1.5" 
                height="0.7" 
                position="0 0.4 0"
                color="#8B5CF6" 
                material="transparent: true; opacity: 0.9" 
                rounded="radius: 0.05">
            </a-plane>

            <a-text 
                value="SmartTour.jo"
                color="#FFFFFF" 
                align="center" 
                width="2.5" 
                position="0 0.55 0.01">
            </a-text>
            
            <a-text 
                value="by Nova Squad"
                color="#E0E0E0"
                align="center" 
                width="1.5" 
                position="0 0.25 0.01">
            </a-text>

        </a-entity>

        <a-entity camera></a-entity>
    </a-scene>

</body>
</html>