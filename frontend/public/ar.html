<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Nearby AR Info</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
  </head>

  <body style="margin: 0; overflow: hidden;">
    <a-scene
      embedded
      vr-mode-ui="enabled: false"
      arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false;"
      renderer="antialias: true; alpha: true"
    >
      <a-camera gps-new-camera rotation-reader></a-camera>

      <a-entity
        id="info-box"
        visible="false"
        text="value: أنت في المكان الصحيح!; color: black; align: center"
        position="0 2 -5"
      ></a-entity>
    </a-scene>

    <script>
      let targetLat = null;
      let targetLon = null;

      // أول مرة بنحدد الموقع الحالي كنقطة الهدف
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          targetLat = pos.coords.latitude;
          targetLon = pos.coords.longitude;
          console.log("Target location set:", targetLat, targetLon);
        },
        (err) => {
          console.error("Failed to get location", err);
        },
        { enableHighAccuracy: true }
      );

      function getDistance(lat1, lon1, lat2, lon2) {
        const R = 6371000;
        const toRad = (deg) => deg * Math.PI / 180;
        const dLat = toRad(lat2 - lat1);
        const dLon = toRad(lon2 - lon1);
        const a =
          Math.sin(dLat / 2) ** 2 +
          Math.cos(toRad(lat1)) *
            Math.cos(toRad(lat2)) *
            Math.sin(dLon / 2) ** 2;
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
      }

      // تحديث موقع المستخدم ومقارنة المسافة مع الهدف
      window.addEventListener("gps-camera-update-position", (e) => {
        if (targetLat === null || targetLon === null) return;

        const userLat = e.detail.position.latitude;
        const userLon = e.detail.position.longitude;

        const distance = getDistance(userLat, userLon, targetLat, targetLon);
        console.log(المسافة لموقعك الأساسي: ${distance.toFixed(2)} متر);

        const infoBox = document.getElementById("info-box");
        infoBox.setAttribute("visible", distance < 6);
      });
    </script>
  </body>
</html>