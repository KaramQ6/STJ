<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartTour.JO - Ø§ÙƒØªØ´Ù Ø§Ù„Ø£Ø±Ø¯Ù† Ø¨Ø°ÙƒØ§Ø¡</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        /* --- General Styles --- */
        :root {
            --primary-color: #8b5cf6;
            --secondary-color: #3b82f6;
            --dark-bg: #0f0f10;
            --content-bg: #111827;
            --card-bg: rgba(31, 41, 55, 0.5);
            --text-primary: #ffffff;
            --text-secondary: #9ca3af;
            --border-color: rgba(75, 85, 99, 0.3);
        }
        html[lang="ar"] body { font-family: 'Cairo', sans-serif; }
        html[lang="en"] body { font-family: 'Poppins', sans-serif; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { line-height: 1.6; color: var(--text-primary); background-color: var(--dark-bg); overflow-x: hidden; }
        html { scroll-behavior: smooth; }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 2rem; }
        .section { padding: 5rem 0; position: relative; }
        .section:nth-child(even) { background-color: var(--content-bg); }
        .section-title { text-align: center; font-size: clamp(2rem, 4vw, 3rem); font-weight: 700; margin-bottom: 1rem; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .section-subtitle { text-align: center; font-size: 1.2rem; color: var(--text-secondary); margin-bottom: 3rem; max-width: 600px; margin-left: auto; margin-right: auto; }
        .btn { padding: 1rem 2rem; border-radius: 50px; font-weight: 600; text-decoration: none; transition: all 0.3s ease; border: none; cursor: pointer; font-size: 1rem; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; }
        .btn-primary { background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; box-shadow: 0 10px 25px rgba(139, 92, 246, 0.3); }
        .btn-primary:hover, .btn-primary:focus { transform: translateY(-3px); box-shadow: 0 15px 35px rgba(139, 92, 246, 0.5); outline: none; }
        
        /* --- Preloader --- */
        #preloader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--dark-bg); z-index: 9999; display: flex; justify-content: center; align-items: center; transition: opacity 0.5s ease; }
        .spinner { width: 50px; height: 50px; border: 5px solid var(--border-color); border-top-color: var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- Navbar --- */
        .navbar { position: fixed; top: 0; width: 100%; background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(10px); z-index: 1000; padding: 1rem 0; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        .nav-container { display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 1.5rem; font-weight: 700; color: var(--primary-color); text-decoration: none; }
        .nav-menu { display: flex; list-style: none; margin: 0; padding: 0; gap: 1.5rem; align-items: center; }
        .nav-link { color: #d1d5db; text-decoration: none; font-weight: 500; padding: 0.5rem 1rem; border-radius: 0.5rem; transition: all 0.3s ease; position: relative; }
        .nav-link:hover, .nav-link.active { color: var(--text-primary); background: rgba(139, 92, 246, 0.2); transform: translateY(-2px); }
        .lang-switcher button { background: none; border: 1px solid #4b5563; color: #d1d5db; padding: 5px 10px; border-radius: 6px; cursor: pointer; font-family: 'Poppins', sans-serif; transition: all 0.2s ease; }
        .lang-switcher button.active { background: var(--primary-color); color: white; border-color: var(--primary-color); }
        .mobile-menu-button { display: none; background: none; border: none; color: white; font-size: 1.8rem; cursor: pointer; z-index: 1001; }

        /* --- Hero Section --- */
        .hero { height: 100vh; position: relative; display: flex; align-items: center; justify-content: center; text-align: center; overflow: hidden; background-color: #111; background-image: url('https://images.pexels.com/photos/1631665/pexels-photo-1631665.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2'); background-size: cover; background-position: center 70%; }
        .hero::after { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(rgba(0,0,0,0.4), rgba(0,0,0,0.4)), linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(59, 130, 246, 0.1)); z-index: 1; }
        .hero-content { position: relative; z-index: 2; max-width: 800px; padding: 0 2rem; animation: fadeInUp 1s ease-out; }
        .hero h1 { font-size: clamp(2.5rem, 5vw, 4rem); font-weight: 700; margin-bottom: 1rem; color: white; text-shadow: 0 4px 8px rgba(0, 0, 0, 0.6); }
        .hero p { font-size: clamp(1.1rem, 2vw, 1.3rem); margin-bottom: 2rem; color: #f3f4f6; text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5); }
        
        /* --- Containers & Cards --- */
        .chatbot-container, .ar-container, .map-container { background: var(--card-bg); border-radius: 1rem; padding: 2rem; backdrop-filter: blur(16px); border: 1px solid var(--border-color); }
        .insights-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 2rem; }
        .insight-card { background: var(--card-bg); border-radius: 1rem; padding: 1.5rem; text-align: center; border: 1px solid var(--border-color); transition: all 0.3s ease; }
        .insight-card:hover { transform: translateY(-5px); box-shadow: 0 10px 30px rgba(139, 92, 246, 0.1); }
        .insight-icon { font-size: 2rem; margin-bottom: 1rem; display: block; }
        .insight-value { font-size: 1.8rem; font-weight: 700; color: var(--primary-color); margin-bottom: 0.5rem; }
        .insight-label { color: var(--text-secondary); font-size: 0.9rem; }
        .categories-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 2rem; }
        .category-card { background: var(--card-bg); border-radius: 1rem; overflow: hidden; border: 1px solid var(--border-color); transition: all 0.3s ease; cursor: pointer; display: flex; flex-direction: column; }
        .category-card:hover { transform: translateY(-5px); box-shadow: 0 20px 40px rgba(139, 92, 246, 0.2); border-color: rgba(139, 92, 246, 0.5); }
        .category-image { height: 200px; background-size: cover; background-position: center; }
        .category-content { padding: 1.5rem; flex-grow: 1; }
        .category-title { font-size: 1.3rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem; }
        .category-description { color: var(--text-secondary); font-size: 0.9rem; line-height: 1.5; }

        /* --- Chatbot --- */
        #chatWindow { background: rgba(15, 15, 16, 0.5); border-radius: 8px; height: 400px; padding: 1rem; overflow-y: auto; margin-bottom: 1rem; display: flex; flex-direction: column; gap: 1rem; border: 1px solid #4b5563; }
        .chat-message { padding: 0.75rem 1rem; border-radius: 12px; max-width: 80%; line-height: 1.5; white-space: pre-wrap; word-wrap: break-word; }
        .user-message { background-color: var(--primary-color); color: white; align-self: flex-end; border-bottom-right-radius: 2px; }
        html[dir="rtl"] .user-message { align-self: flex-start; border-bottom-right-radius: 12px; border-bottom-left-radius: 2px; }
        .bot-message { background-color: #374151; color: #f3f4f6; align-self: flex-start; border-bottom-left-radius: 2px; }
        html[dir="rtl"] .bot-message { align-self: flex-end; border-bottom-left-radius: 12px; border-bottom-right-radius: 2px; }
        .chat-input-area { display: flex; gap: 1rem; }
        #chatInput { flex-grow: 1; padding: 1rem; border-radius: 8px; border: 1px solid #4b5563; background-color: #1f2937; color: white; font-size: 1rem; }
        #sendButton:disabled { background: #5a4b8c; cursor: not-allowed; }

        /* --- Map --- */
        #map { height: 500px; border-radius: 0.5rem; z-index: 1; }
        
        /* --- Modal --- */
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(8px); align-items: center; justify-content: center; }
        .modal-content { background: #1f2937; padding: 2rem; border-radius: 1rem; width: 90%; max-width: 600px; position: relative; animation: modalSlideIn 0.3s ease; }
        .modal-close { position: absolute; top: 1rem; right: 1rem; font-size: 1.5rem; cursor: pointer; color: var(--text-secondary); transition: color 0.3s ease; }
        html[lang="ar"] .modal-close { right: auto; left: 1rem; }
        .modal-close:hover { color: var(--text-primary); }

        /* --- Footer & Back to Top --- */
        .footer { background: #0a0a0a; padding: 3rem 0 2rem; text-align: center; }
        .footer p { color: #6b7280; font-size: 0.9rem; }
        .back-to-top { position: fixed; bottom: 2rem; right: 2rem; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; width: 50px; height: 50px; border-radius: 50%; border: none; cursor: pointer; display: none; align-items: center; justify-content: center; z-index: 1000; font-size: 1.5rem; }
        html[lang="ar"] .back-to-top { right: auto; left: 2rem; }
        
        /* --- Animations --- */
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes modalSlideIn { from { opacity: 0; transform: translateY(-50px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Responsive Design --- */
        @media (max-width: 768px) {
            .nav-menu {
                display: none;
                position: absolute;
                top: 100%;
                left: 0;
                width: 100%;
                background: rgba(0, 0, 0, 0.95);
                backdrop-filter: blur(10px);
                flex-direction: column;
                padding: 1rem 0;
                border-top: 1px solid var(--border-color);
            }
            .nav-menu.active { display: flex; }
            .nav-menu li { width: 100%; text-align: center; }
            .nav-link { display: block; padding: 1rem; }
            .lang-switcher { justify-content: center; padding: 1rem 0; }
            .mobile-menu-button { display: block; }
        }
    </style>
</head>
<body>
    <div id="preloader"><div class="spinner"></div></div>

    <nav class="navbar">
        <div class="nav-container container">
            <a class="logo" href="#hero" data-translate="siteTitle"></a>
            <button class="mobile-menu-button" id="mobileMenuBtn" aria-label="Toggle menu">â˜°</button>
            <ul class="nav-menu" id="navMenu">
                <li><a class="nav-link" href="#hero" data-translate="navHome"></a></li>
                <li><a class="nav-link" href="#chatbot" data-translate="navAIGuide"></a></li>
                <li><a class="nav-link" href="#insights" data-translate="navInsights"></a></li>
                <li><a class="nav-link" href="#ar-experience" data-translate="navAR"></a></li>
                <li><a class="nav-link" href="#map-section" data-translate="navMap"></a></li>
                <li><a class="nav-link" href="#categories" data-translate="navExplore"></a></li>
                <li class="lang-switcher">
                    <button id="lang-ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</button>
                    <button id="lang-en">English</button>
                </li>
            </ul>
        </div>
    </nav>

    <main>
        <section class="hero" id="hero">
            <div class="hero-content">
                <h1 data-translate="heroTitle"></h1>
                <p data-translate="heroSubtitle"></p>
                <div class="hero-buttons">
                    <a class="btn btn-primary" href="#chatbot" data-translate="heroBtnStart"></a>
                </div>
            </div>
        </section>
        
        <section class="section" id="chatbot">
            <div class="container">
                <h2 class="section-title" data-translate="chatbotTitle"></h2>
                <p class="section-subtitle" data-translate="chatbotSubtitle"></p>
                <div class="chatbot-container">
                    <div id="chatWindow"></div>
                    <div class="chat-input-area">
                        <input id="chatInput" type="text" data-translate-placeholder="chatPlaceholder" />
                        <button id="sendButton" class="btn btn-primary">
                            <span class="send-text" data-translate="chatSend"></span>
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <section class="section" id="insights">
            <div class="container">
                <h2 class="section-title" data-translate="insightsTitle"></h2>
                <p class="section-subtitle" data-translate="insightsSubtitle"></p>
                <div class="insights-grid">
                    <div class="insight-card"><span class="insight-icon">ğŸŒ¡ï¸</span><div class="insight-value" id="temp">--Â°C</div><div class="insight-label" data-translate="insightTemp"></div></div>
                    <div class="insight-card"><span class="insight-icon">ğŸ‘¥</span><div class="insight-value" id="crowd">--</div><div class="insight-label" data-translate="insightCrowd"></div></div>
                    <div class="insight-card"><span class="insight-icon">ğŸ’§</span><div class="insight-value" id="humidity">--%</div><div class="insight-label" data-translate="insightHumidity"></div></div>
                    <div class="insight-card"><span class="insight-icon">ğŸŒ¬ï¸</span><div class="insight-value" id="air-quality">--</div><div class="insight-label" data-translate="insightAir"></div></div>
                </div>
            </div>
        </section>

        <section class="section" id="ar-experience">
            <div class="container ar-container" style="text-align:center;">
                <h2 class="section-title" data-translate="arTitle"></h2>
                <p class="section-subtitle" data-translate="arSubtitle"></p>
                <a href="ar.html" class="btn btn-primary" data-translate="arBtn"></a>
            </div>
        </section>
        
        <section class="section" id="map-section">
            <div class="container">
                <h2 class="section-title" data-translate="mapTitle"></h2>
                <p class="section-subtitle" data-translate="mapSubtitle"></p>
                <div class="map-container">
                    <div id="map"></div>
                </div>
            </div>
        </section>

        <section class="section" id="categories">
            <div class="container">
                <h2 class="section-title" data-translate="categoriesTitle"></h2>
                <p class="section-subtitle" data-translate="categoriesSubtitle"></p>
                <div class="categories-grid"></div>
            </div>
        </section>
    </main>

    <footer class="footer">
        <div class="container">
            <p data-translate="footerRights"></p>
        </div>
    </footer>
    
    <div id="natureModal" class="modal"><div class="modal-content"><span class="modal-close">&times;</span><h2 class="modal-title" data-translate="modalNatureTitle"></h2><p class="modal-text" data-translate="modalNatureText"></p></div></div>
    <div id="cultureModal" class="modal"><div class="modal-content"><span class="modal-close">&times;</span><h2 class="modal-title" data-translate="modalCultureTitle"></h2><p class="modal-text" data-translate="modalCultureText"></p></div></div>
    <div id="religiousModal" class="modal"><div class="modal-content"><span class="modal-close">&times;</span><h2 class="modal-title" data-translate="modalReligiousTitle"></h2><p class="modal-text" data-translate="modalReligiousText"></p></div></div>
    <div id="adventureModal" class="modal"><div class="modal-content"><span class="modal-close">&times;</span><h2 class="modal-title" data-translate="modalAdventureTitle"></h2><p class="modal-text" data-translate="modalAdventureText"></p></div></div>

    <button class="back-to-top" id="backToTop" aria-label="Back to top">â†‘</button>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function () {
        // --- 1. CONFIGURATION & DATA ---
        const config = {
            weatherApiKey: '91859b46e4ef01b5415a2f8b1ddbfac1', //  Ø¶Ø¹ Ù…ÙØªØ§Ø­Ùƒ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ù…Ù† OpenWeatherMap
            aiApiUrl: 'https://YOUR_CLOUDFLARE_WORKER_URL.workers.dev/', //  Ø¶Ø¹ Ø±Ø§Ø¨Ø· Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù‡Ù†Ø§
            fallbackLocation: 'Amman',
            updateInterval: 300000 // 5 minutes
        };

        const translations = {
            en: { siteTitle: "SmartTour.JO", navHome: "Home", navAIGuide: "AI Guide", navInsights: "Insights", navAR: "AR View", navMap: "Map", navExplore: "Explore", arTitle: "Augmented Reality", arSubtitle: "Bring Jordan's history to life.", arBtn: "Launch AR Experience", heroTitle: "Explore Jordan Smarter", heroSubtitle: "Discover hidden treasures with AI recommendations.", heroBtnStart: "Start Your Journey", chatbotTitle: "Ask Our Smart AI Guide", chatbotSubtitle: "Get instant answers about Jordan.", chatPlaceholder: "Request a tour plan...", chatSend: "Send", chatThinking: "Thinking...", chatError: "Connection failed. Please try again.", insightsTitle: "Live Environment Insights", insightsSubtitle: "Real-time data from your location.", insightTemp: "Temperature", insightCrowd: "Crowd Level", insightHumidity: "Humidity", insightAir: "Air Quality", mapTitle: "Interactive Jordan Map", mapSubtitle: "Explore Jordan's attractions.", categoriesTitle: "Discover Jordan Your Way", categoriesSubtitle: "Find experiences that match your interests.", footerRights: `Â© ${new Date().getFullYear()} SmartTour.JO. All rights reserved.`, modalNatureTitle: "Nature", modalNatureText: "From the deserts of Wadi Rum to the therapeutic waters of the Dead Sea.", modalCultureTitle: "Culture", modalCultureText: "Explore ancient Petra, Roman ruins of Jerash, and authentic Bedouin culture.", modalReligiousTitle: "Religious Sites", modalReligiousText: "Follow biblical paths to Mount Nebo, Bethany, and other sacred sites.", modalAdventureTitle: "Adventure", modalAdventureText: "Experience thrilling adventures like desert camping, Red Sea diving, and canyoning.", yourLocationPopup: "<b>Your Location</b>", petraPopup:"Petra", jerashPopup:"Jerash", wadiRumPopup:"Wadi Rum", ajlounPopup: "Ajloun Castle", aqabaPopup: "Aqaba", deadSeaPopup: "Dead Sea", crowdLevels: ["Low", "Medium", "High", "Very High"], airQualityLevels: ["Good", "Moderate", "Poor"] },
            ar: { siteTitle: "SmartTour.JO", navHome: "Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©", navAIGuide: "Ø§Ù„Ù…Ø±Ø´Ø¯ Ø§Ù„Ø°ÙƒÙŠ", navInsights: "Ù…Ø¤Ø´Ø±Ø§Øª Ø­ÙŠÙˆÙŠØ©", navAR: "Ø§Ù„ÙˆØ§Ù‚Ø¹ Ø§Ù„Ù…Ø¹Ø²Ø²", navMap: "Ø§Ù„Ø®Ø±ÙŠØ·Ø©", navExplore: "Ø§ÙƒØªØ´Ù", arTitle: "ØªØ¬Ø±Ø¨Ø© Ø§Ù„ÙˆØ§Ù‚Ø¹ Ø§Ù„Ù…Ø¹Ø²Ø²", arSubtitle: "Ø£Ø¹Ø¯ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø£Ø±Ø¯Ù† Ø¥Ù„Ù‰ Ø§Ù„Ø­ÙŠØ§Ø©.", arBtn: "Ø´ØºÙ‘Ù„ Ø§Ù„ØªØ¬Ø±Ø¨Ø©", heroTitle: "Ø§ÙƒØªØ´Ù Ø§Ù„Ø£Ø±Ø¯Ù† Ø¨Ø°ÙƒØ§Ø¡", heroSubtitle: "Ø§ÙƒØªØ´Ù ÙƒÙ†ÙˆØ² Ø§Ù„Ø£Ø±Ø¯Ù† Ø§Ù„Ø®ÙÙŠØ© Ù…Ø¹ ØªÙˆØµÙŠØ§Øª Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ.", heroBtnStart: "Ø§Ø¨Ø¯Ø£ Ø±Ø­Ù„ØªÙƒ", chatbotTitle: "Ø§Ø³Ø£Ù„ Ù…Ø±Ø´Ø¯Ù†Ø§ Ø§Ù„Ø°ÙƒÙŠ", chatbotSubtitle: "Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø¥Ø¬Ø§Ø¨Ø§Øª ÙÙˆØ±ÙŠØ© Ø­ÙˆÙ„ Ù…Ø¹Ø§Ù„Ù… Ø§Ù„Ø£Ø±Ø¯Ù†.", chatPlaceholder: "Ø§Ø·Ù„Ø¨ Ø®Ø·Ø© Ø³ÙŠØ§Ø­ÙŠØ©...", chatSend: "Ø£Ø±Ø³Ù„", chatThinking: "...Ù„Ø­Ø¸Ø© Ù…Ù† ÙØ¶Ù„Ùƒ", chatError: "âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.", insightsTitle: "Ù…Ø¤Ø´Ø±Ø§Øª Ø¨ÙŠØ¦ÙŠØ© Ø­ÙŠØ©", insightsSubtitle: "Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø­Ø¸ÙŠØ© Ù…Ù† Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ.", insightTemp: "Ø¯Ø±Ø¬Ø© Ø§Ù„Ø­Ø±Ø§Ø±Ø©", insightCrowd: "Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø§Ø²Ø¯Ø­Ø§Ù…", insightHumidity: "Ø§Ù„Ø±Ø·ÙˆØ¨Ø©", insightAir: "Ø¬ÙˆØ¯Ø© Ø§Ù„Ù‡ÙˆØ§Ø¡", mapTitle: "Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø£Ø±Ø¯Ù† Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ©", mapSubtitle: "Ø§Ø³ØªÙƒØ´Ù Ù…Ø¹Ø§Ù„Ù… Ø§Ù„Ø£Ø±Ø¯Ù† ÙˆØ®Ø·Ø· Ù…Ø³Ø§Ø±Ùƒ.", categoriesTitle: "Ø§ÙƒØªØ´Ù Ø§Ù„Ø£Ø±Ø¯Ù† Ø¹Ù„Ù‰ Ø·Ø±ÙŠÙ‚ØªÙƒ", categoriesSubtitle: "Ø§Ø®ØªØ± Ù…Ù† ÙØ¦Ø§ØªÙ†Ø§ Ø§Ù„Ù…Ù†Ø³Ù‚Ø© Ù„ØªØ¬Ø¯ Ù…Ø§ ÙŠÙ†Ø§Ø³Ø¨Ùƒ.", footerRights: `Â© ${new Date().getFullYear()} SmartTour.JO. Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©.`, modalNatureTitle: "Ø·Ø¨ÙŠØ¹Ø©", modalNatureText: "Ù…Ù† ØµØ­Ø±Ø§Ø¡ ÙˆØ§Ø¯ÙŠ Ø±Ù… Ø§Ù„Ø´Ø§Ø³Ø¹Ø© Ø¥Ù„Ù‰ Ù…ÙŠØ§Ù‡ Ø§Ù„Ø¨Ø­Ø± Ø§Ù„Ù…ÙŠØª Ø§Ù„Ø¹Ù„Ø§Ø¬ÙŠØ©.", modalCultureTitle: "Ø«Ù‚Ø§ÙØ©", modalCultureText: "Ø§Ø³ØªÙƒØ´Ù Ø§Ù„Ø¨ØªØ±Ø§Ø¡ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©ØŒ ÙˆØ¢Ø«Ø§Ø± Ø¬Ø±Ø´ Ø§Ù„Ø±ÙˆÙ…Ø§Ù†ÙŠØ©ØŒ ÙˆØ§Ù„ØªÙ‚Ø§Ù„ÙŠØ¯ Ø§Ù„Ø¨Ø¯ÙˆÙŠØ© Ø§Ù„Ø£ØµÙŠÙ„Ø©.", modalReligiousTitle: "Ù…ÙˆØ§Ù‚Ø¹ Ø¯ÙŠÙ†ÙŠØ©", modalReligiousText: "Ø§ØªØ¨Ø¹ Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ù…Ù‚Ø¯Ø³Ø© Ø¥Ù„Ù‰ Ø¬Ø¨Ù„ Ù†ÙŠØ¨Ùˆ ÙˆØ§Ù„Ù…ØºØ·Ø³ ÙˆØºÙŠØ±Ù‡Ø§.", modalAdventureTitle: "Ù…ØºØ§Ù…Ø±Ø©", modalAdventureText: "Ø¬Ø±Ø¨ Ù…ØºØ§Ù…Ø±Ø§Øª Ù…Ø«ÙŠØ±Ø© Ù…Ø«Ù„ Ø§Ù„ØªØ®ÙŠÙŠÙ… Ø§Ù„ØµØ­Ø±Ø§ÙˆÙŠØŒ ÙˆØ§Ù„ØºÙˆØµØŒ ÙˆØ§Ø³ØªÙƒØ´Ø§Ù Ø§Ù„Ø£ÙˆØ¯ÙŠØ©.", yourLocationPopup: "<b>Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ</b>", petraPopup:"Ø§Ù„Ø¨ØªØ±Ø§Ø¡", jerashPopup:"Ø¬Ø±Ø´", wadiRumPopup:"ÙˆØ§Ø¯ÙŠ Ø±Ù…", ajlounPopup: "Ù‚Ù„Ø¹Ø© Ø¹Ø¬Ù„ÙˆÙ†", aqabaPopup: "Ø§Ù„Ø¹Ù‚Ø¨Ø©", deadSeaPopup: "Ø§Ù„Ø¨Ø­Ø± Ø§Ù„Ù…ÙŠØª", crowdLevels: ["Ù…Ù†Ø®ÙØ¶", "Ù…ØªÙˆØ³Ø·", "Ù…Ø±ØªÙØ¹", "Ù…Ø±ØªÙØ¹ Ø¬Ø¯Ø§Ù‹"], airQualityLevels: ["Ø¬ÙŠØ¯Ø©", "Ù…ØªÙˆØ³Ø·Ø©", "Ø³ÙŠØ¦Ø©"] }
        };

        const categoriesData = {
            en: [ { id: 'nature', title: 'ğŸŒ¿ Nature', description: 'Vast deserts of Wadi Rum, therapeutic Dead Sea.', image: 'https://images.pexels.com/photos/2440339/pexels-photo-2440339.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2' }, { id: 'culture', title: 'ğŸ›ï¸ Culture', description: 'The ancient city of Petra, Roman ruins of Jerash.', image: 'https://images.pexels.com/photos/1587747/pexels-photo-1587747.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2' }, { id: 'religious', title: 'â›ª Religious', description: 'The Baptism Site "Bethany Beyond the Jordan".', image: 'https://images.pexels.com/photos/14986348/pexels-photo-14986348.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2' }, { id: 'adventure', title: 'ğŸ§— Adventure', description: 'Canyoning in Wadi Mujib, diving in Aqaba.', image: 'https://images.pexels.com/photos/7989333/pexels-photo-7989333.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2' } ],
            ar: [ { id: 'nature', title: 'ğŸŒ¿ Ø·Ø¨ÙŠØ¹Ø© Ø®Ù„Ø§Ø¨Ø©', description: 'ØµØ­Ø±Ø§Ø¡ ÙˆØ§Ø¯ÙŠ Ø±Ù… Ø§Ù„Ø´Ø§Ø³Ø¹Ø© ÙˆÙ…ÙŠØ§Ù‡ Ø§Ù„Ø¨Ø­Ø± Ø§Ù„Ù…ÙŠØª Ø§Ù„Ø¹Ù„Ø§Ø¬ÙŠØ©.', image: 'https://images.pexels.com/photos/2440339/pexels-photo-2440339.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2' }, { id: 'culture', title: 'ğŸ›ï¸ Ø«Ù‚Ø§ÙØ© ÙˆØªØ§Ø±ÙŠØ®', description: 'Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ø¨ØªØ±Ø§Ø¡ Ø§Ù„Ø£Ø«Ø±ÙŠØ© ÙˆØ£Ø¹Ù…Ø¯Ø© Ø¬Ø±Ø´ Ø§Ù„Ø±ÙˆÙ…Ø§Ù†ÙŠØ©.', image: 'https://images.pexels.com/photos/1587747/pexels-photo-1587747.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2' }, { id: 'religious', title: 'â›ª Ù…ÙˆØ§Ù‚Ø¹ Ø¯ÙŠÙ†ÙŠØ©', description: 'Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…ØºØ·Ø³ "Ø¨ÙŠØª Ø¹Ù†ÙŠØ§ Ø¹Ø¨Ø± Ø§Ù„Ø£Ø±Ø¯Ù†".', image: 'https://images.pexels.com/photos/14986348/pexels-photo-14986348.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2' }, { id: 'adventure', title: 'ğŸ§— Ù…ØºØ§Ù…Ø±Ø§Øª ÙˆØªØ­Ø¯ÙŠ', description: 'Ø§Ø³ØªÙƒØ´Ø§Ù Ø§Ù„Ø£ÙˆØ¯ÙŠØ© ÙÙŠ ÙˆØ§Ø¯ÙŠ Ø§Ù„Ù…ÙˆØ¬Ø¨ ÙˆØ§Ù„ØºÙˆØµ ÙÙŠ Ø§Ù„Ø¹Ù‚Ø¨Ø©.', image: 'https://images.pexels.com/photos/7989333/pexels-photo-7989333.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2' } ]
        };
        
        const touristSites = {
            petra: { coords: [30.3285, 35.4444], nameKey: "petraPopup" },
            jerash: { coords: [32.2730, 35.8911], nameKey: "jerashPopup" },
            wadiRum: { coords: [29.5732, 35.4194], nameKey: "wadiRumPopup" },
            ajloun: { coords: [32.3335, 35.7516], nameKey: "ajlounPopup" },
            aqaba: { coords: [29.5266, 35.0078], nameKey: "aqabaPopup" },
            deadSea: { coords: [31.5590, 35.5869], nameKey: "deadSeaPopup" },
        };

        // --- 2. STATE MANAGEMENT ---
        const state = {
            lang: localStorage.getItem('language') || 'ar',
            map: null,
            markers: {}
        };

        // --- 3. DOM ELEMENTS ---
        const DOMElements = {
            html: document.documentElement,
            preloader: document.getElementById('preloader'),
            navMenu: document.getElementById('navMenu'),
            mobileMenuBtn: document.getElementById('mobileMenuBtn'),
            langArBtn: document.getElementById('lang-ar'),
            langEnBtn: document.getElementById('lang-en'),
            categoriesGrid: document.querySelector('.categories-grid'),
            modals: document.querySelectorAll('.modal'),
            modalCloseBtns: document.querySelectorAll('.modal-close'),
            backToTopBtn: document.getElementById('backToTop'),
            chat: {
                window: document.getElementById('chatWindow'),
                input: document.getElementById('chatInput'),
                sendBtn: document.getElementById('sendButton'),
                sendBtnText: document.querySelector('#sendButton .send-text')
            },
            insights: {
                temp: document.getElementById('temp'),
                crowd: document.getElementById('crowd'),
                humidity: document.getElementById('humidity'),
                airQuality: document.getElementById('air-quality')
            }
        };

        // --- 4. CORE FUNCTIONS ---

        /**
         * Sets the application language
         * @param {string} lang - 'ar' or 'en'
         */
        function setLanguage(lang) {
            state.lang = lang;
            DOMElements.html.lang = lang;
            DOMElements.html.dir = lang === 'ar' ? 'rtl' : 'ltr';
            localStorage.setItem('language', lang);

            // Update all text content
            document.querySelectorAll('[data-translate]').forEach(el => {
                const key = el.getAttribute('data-translate');
                el.textContent = translations[lang][key] || '';
            });

            // Update all placeholders
            document.querySelectorAll('[data-translate-placeholder]').forEach(el => {
                const key = el.getAttribute('data-translate-placeholder');
                el.placeholder = translations[lang][key] || '';
            });

            // Update language switcher UI
            DOMElements.langArBtn.classList.toggle('active', lang === 'ar');
            DOMElements.langEnBtn.classList.toggle('active', lang === 'en');

            // Repopulate dynamic content
            populateCategories();
            updateMapPopups();
            updateSimulatedData(); // Update language-dependent simulated data
        }

        /**
         * Populates the categories section
         */
        function populateCategories() {
            const lang = state.lang;
            DOMElements.categoriesGrid.innerHTML = '';
            categoriesData[lang].forEach(cat => {
                const card = document.createElement('div');
                card.className = 'category-card';
                card.innerHTML = `
                    <div class="category-image" style="background-image: url('${cat.image}')"></div>
                    <div class="category-content">
                        <h3 class="category-title">${cat.title}</h3>
                        <p class="category-description">${cat.description}</p>
                    </div>`;
                card.addEventListener('click', () => openModal(cat.id));
                DOMElements.categoriesGrid.appendChild(card);
            });
        }

        /**
         * Opens a specific modal
         * @param {string} modalId - The ID of the category (e.g., 'nature')
         */
        function openModal(modalId) {
            const modal = document.getElementById(modalId + 'Modal');
            if(modal) {
                modal.style.display = 'flex';
            }
        }
        
        /**
         * Hides all modals
         */
        function closeAllModals() {
             DOMElements.modals.forEach(modal => modal.style.display = 'none');
        }

        /**
         * Fetches and displays weather and simulated data
         */
        async function updateInsights() {
            const updateSimulated = () => updateSimulatedData();
            
            const fetchWeatherData = async (url) => {
                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error('Weather API request failed');
                    const data = await response.json();
                    DOMElements.insights.temp.innerText = `${Math.round(data.main.temp)}Â°C`;
                    DOMElements.insights.humidity.innerText = `${data.main.humidity}%`;
                } catch (error) {
                    console.error('Fetch weather error:', error);
                    // Fallback to default values on error
                    DOMElements.insights.temp.innerText = `25Â°C`;
                    DOMElements.insights.humidity.innerText = `40%`;
                }
            };
            
            const getWeatherByCoords = (lat, lon) => {
                const apiUrl = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${config.weatherApiKey}&units=metric`;
                fetchWeatherData(apiUrl);
            };

            const getWeatherByCity = (city) => {
                const apiUrl = `https://api.openweathermap.org/data/2.5/weather?q=${city}&appid=${config.weatherApiKey}&units=metric`;
                fetchWeatherData(apiUrl);
            };

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => getWeatherByCoords(position.coords.latitude, position.coords.longitude),
                    (error) => {
                        console.error("Geolocation error:", error.message);
                        getWeatherByCity(config.fallbackLocation); // Fallback on geolocation error
                    }
                );
            } else {
                getWeatherByCity(config.fallbackLocation); // Fallback if geolocation is not supported
            }
            
            updateSimulated();
        }
        
        /**
         * Updates simulated data based on current language
         */
        function updateSimulatedData() {
            const lang = state.lang;
            const crowdLevels = translations[lang].crowdLevels;
            const airQualityLevels = translations[lang].airQualityLevels;
            DOMElements.insights.crowd.innerText = crowdLevels[Math.floor(Math.random() * crowdLevels.length)];
            DOMElements.insights.airQuality.innerText = airQualityLevels[Math.floor(Math.random() * airQualityLevels.length)];
        }


        /**
         * Initializes the Leaflet map
         */
        function initMap() {
            state.map = L.map('map').setView([31.95, 35.93], 7); // Default to Amman center
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { 
                attribution: '&copy; OpenStreetMap contributors' 
            }).addTo(state.map);
            
            // Icons
            const redIcon = new L.Icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png', shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41] });
            const blueIcon = new L.Icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png', shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41] });
            
            // Add tourist site markers
            for (const key in touristSites) {
                const site = touristSites[key];
                state.markers[key] = L.marker(site.coords, { icon: blueIcon }).addTo(state.map);
            }
            updateMapPopups();

            // Get and show user location
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(pos => {
                    const userLoc = [pos.coords.latitude, pos.coords.longitude];
                    state.map.setView(userLoc, 13);
                    state.markers.user = L.marker(userLoc, { icon: redIcon }).addTo(state.map).openPopup();
                    updateMapPopups(); // Update user popup text after it's created
                });
            }
            
            // Fix map size issue when it's in a hidden tab/section
            setTimeout(() => { state.map.invalidateSize() }, 400);
        }

        /**
         * Updates map marker popups with the current language
         */
        function updateMapPopups() {
            const lang = state.lang;
            if (!state.map) return;

            for (const key in touristSites) {
                const site = touristSites[key];
                const popupText = translations[lang][site.nameKey];
                if (state.markers[key]) {
                    state.markers[key].bindPopup(`<b>${popupText}</b>`);
                }
            }

            if (state.markers.user) {
                const popupText = translations[lang].yourLocationPopup;
                state.markers.user.bindPopup(popupText);
            }
        }
        
        /**
         * Handles the AI chatbot logic
         */
        function initChatbot() {
            let chatHistory = [];
            const systemPrompt = "You are 'SmartTour.JO AI Assistant', an expert, friendly, and welcoming tour guide for Jordan. Your primary language is Arabic, but you can respond in English if asked. Your sole focus is providing helpful information about tourism, history, culture, food, and activities within Jordan. If asked about any other topic (e.g., politics, other countries, programming), you must politely decline and gently steer the conversation back to Jordan tourism. For example: 'Ù…Ù‡Ù…ØªÙŠ Ù‡ÙŠ Ø¥Ø±Ø´Ø§Ø¯Ùƒ ÙÙŠ Ø§Ù„Ø£Ø±Ø¯Ù†. Ù‡Ù„ Ù„Ø¯ÙŠÙƒ Ø£ÙŠ Ø£Ø³Ø¦Ù„Ø© Ø¹Ù† Ø£Ù…Ø§ÙƒÙ† Ø³ÙŠØ§Ø­ÙŠØ© Ø£Ùˆ Ø£Ù†Ø´Ø·Ø© ÙŠÙ…ÙƒÙ† Ø§Ù„Ù‚ÙŠØ§Ù… Ø¨Ù‡Ø§ Ù‡Ù†Ø§ØŸ' or 'My purpose is to be your guide in Jordan. Do you have any questions about its beautiful sites?' Keep your answers concise and helpful.";

            const appendMessage = (text, type) => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `chat-message ${type}-message`;
                messageDiv.innerText = text; // Using innerText to prevent HTML injection
                DOMElements.chat.window.appendChild(messageDiv);
                DOMElements.chat.window.scrollTop = DOMElements.chat.window.scrollHeight;
                return messageDiv;
            };

            const sendMessage = async () => {
                const userInput = DOMElements.chat.input.value.trim();
                if (!userInput) return;

                appendMessage(userInput, 'user');
                
                // Initialize history with system prompt on first message
                if (chatHistory.length === 0) {
                    chatHistory.push({ role: 'user', parts: [{ text: systemPrompt }] });
                }
                chatHistory.push({ role: 'user', parts: [{ text: userInput }] });

                DOMElements.chat.input.value = '';
                DOMElements.chat.sendBtn.disabled = true;
                DOMElements.chat.sendBtnText.textContent = translations[state.lang].chatThinking;
                
                const thinkingMessage = appendMessage('...', 'bot');

                try {
                    const response = await fetch(config.aiApiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ history: chatHistory })
                    });
                    if (!response.ok) throw new Error(`Network error: ${response.status}`);
                    
                    const data = await response.json();
                    const botResponse = data.response;
                    
                    thinkingMessage.innerText = botResponse; // Update thinking message with real response
                    
                    chatHistory.push({ role: 'model', parts: [{ text: botResponse }] });

                } catch (error) {
                    console.error("Chatbot API error:", error);
                    thinkingMessage.innerText = translations[state.lang].chatError;
                } finally {
                    DOMElements.chat.sendBtn.disabled = false;
                    DOMElements.chat.sendBtnText.textContent = translations[state.lang].chatSend;
                    DOMElements.chat.input.focus();
                }
            };
            
            DOMElements.chat.sendBtn.addEventListener('click', sendMessage);
            DOMElements.chat.input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !DOMElements.chat.sendBtn.disabled) {
                    sendMessage();
                }
            });
        }
        
        /**
         * Sets up the mobile navigation toggle
         */
        function initMobileNav() {
            DOMElements.mobileMenuBtn.addEventListener('click', () => {
                DOMElements.navMenu.classList.toggle('active');
            });
            // Close mobile menu when a link is clicked
            DOMElements.navMenu.querySelectorAll('a').forEach(link => {
                link.addEventListener('click', () => {
                     DOMElements.navMenu.classList.remove('active');
                });
            });
        }

        /**
         * Highlights the current section in the nav bar on scroll
         */
        function initScrollSpy() {
            const sections = document.querySelectorAll('section');
            const navLinks = document.querySelectorAll('.nav-menu a.nav-link');
            
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        navLinks.forEach(link => {
                            link.classList.remove('active');
                            if (link.getAttribute('href').substring(1) === entry.target.id) {
                                link.classList.add('active');
                            }
                        });
                    }
                });
            }, { rootMargin: '-50% 0px -50% 0px' });

            sections.forEach(section => observer.observe(section));
        }

        /**
         * Initializes all event listeners
         */
        function initEventListeners() {
            // Language switchers
            DOMElements.langEnBtn.addEventListener('click', () => setLanguage('en'));
            DOMElements.langArBtn.addEventListener('click', () => setLanguage('ar'));

            // Modal closing
            DOMElements.modalCloseBtns.forEach(btn => btn.addEventListener('click', closeAllModals));
            DOMElements.modals.forEach(modal => modal.addEventListener('click', (e) => {
                if (e.target === modal) closeAllModals();
            }));
            window.addEventListener('keydown', (e) => {
                if(e.key === 'Escape') closeAllModals();
            });

            // Back to top button
            window.addEventListener('scroll', () => {
                DOMElements.backToTopBtn.style.display = (window.scrollY > 300) ? 'flex' : 'none';
            });
            DOMElements.backToTopBtn.addEventListener('click', () => {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
        }

        // --- 5. INITIALIZATION ---
        function init() {
            // Hide preloader once content is loaded
            window.addEventListener('load', () => {
                DOMElements.preloader.style.opacity = '0';
                setTimeout(() => { DOMElements.preloader.style.display = 'none'; }, 500);
            });
            
            initMobileNav();
            initEventListeners();
            setLanguage(state.lang); // Initial language setup
            updateInsights();
            setInterval(updateInsights, config.updateInterval);
            initMap();
            initChatbot();
            initScrollSpy();
        }

        init();
    });
    </script>
</body>
</html>